Долго мучался, находил разные варианты в интернете, но понял, что пока сам не создам с нуля - не пойму.
В итоге получилась такая простыня. Понимаю, что это не "попитоновски", но хотя бы ОНО РАБОТАЕТ! :]